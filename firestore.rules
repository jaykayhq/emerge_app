rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ENHANCED: Comprehensive input validation to prevent XSS, NoSQL injection, and other attacks
    function sanitizeString(input) {
      return input is string &&
             input.size() > 0 &&
             input.size() <= 1000 &&
             // Block HTML tags and script injection
             !input.matches('(\\<[^>]*\\>)|(&#)|(&amp;)|(&lt;)|(&gt;)|(&quot;)|(&apos;)') &&
             // Block JavaScript protocols and event handlers
             !input.matches('(javascript:)|on\\w+\\s*=') &&
             // Block template literal injection (Dart/JavaScript)
             !input.matches('(\\${.*})|(`.*`)') &&
             // Block NoSQL injection operators
             !input.matches('(\\$where|\\$ne|\\$gt|\\$lt|\\$in|\\$or|\\$and)') &&
             // Block basic HTML characters (redundant but safe)
             !input.matches('.*[<>].*');
    }

    // Helper function to validate email format
    function isValidEmail(email) {
      return email is string &&
             email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    // Helper function to rate limit writes (currently disabled - custom claims not set up)
    // Note: To enable rate limiting, you need to set up custom claims via Cloud Functions.
    function rateLimited() {
      return true; // Disabled - custom claims not configured
      // Original implementation (requires custom claims):
      // return resource == null 
      //        || (request.time < resource.data.timestamp + duration.value(1, 'm')
      //            ? request.auth.token.writes_per_minute < 5
      //            : true);
    }

    // Helper function to validate user data with enhanced security
    function isValidUser(user) {
      return user.keys().size() <= 60 && // Expanded limit to accommodate profile fields
             (!user.keys().hasAny(['email']) || isValidEmail(user.email)) &&
             (!user.keys().hasAny(['displayName']) || (sanitizeString(user.displayName) && user.displayName.size() <= 50)) &&
             (!user.keys().hasAny(['createdAt']) || user.createdAt is timestamp) &&
             !user.keys().hasAny(['isAdmin', 'role', 'permissions']); // Prevent privilege escalation
    }

    // Helper function to validate habit data with enhanced security
    function isValidHabit(habit) {
      // Essential fields that must be present
      return habit.keys().hasAll(['title', 'userId']) &&
             habit.keys().size() <= 30 && // Increased limit for full feature set
             sanitizeString(habit.title) &&
             habit.title.size() <= 100 &&
             habit.userId == request.auth.uid &&
             
             // Optional fields validation (allow empty strings for optional text fields)
             (!habit.keys().hasAny(['cue']) || habit.cue is string) &&
             (!habit.keys().hasAny(['routine']) || habit.routine is string) &&
             (!habit.keys().hasAny(['reward']) || habit.reward is string) &&
             (!habit.keys().hasAny(['location']) || habit.location == null || habit.location is string) &&
             (!habit.keys().hasAny(['anchorHabitId']) || (habit.anchorHabitId is string)) &&
             (!habit.keys().hasAny(['imageUrl']) || (habit.imageUrl is string)) &&
             
             // Enums and constrained strings (accept both formats: 'daily' and 'HabitFrequency.daily')
             (!habit.keys().hasAny(['frequency']) || habit.frequency in ['daily', 'weekly', 'specificDays', 'HabitFrequency.daily', 'HabitFrequency.weekly', 'HabitFrequency.specificDays']) &&
             (!habit.keys().hasAny(['difficulty']) || habit.difficulty in ['easy', 'medium', 'hard']) &&
             (!habit.keys().hasAny(['impact']) || habit.impact in ['positive', 'negative', 'neutral']) &&
             (!habit.keys().hasAny(['attribute']) || habit.attribute in ['vitality', 'focus', 'strength', 'creativity', 'intellect']) &&
             
             // Boolean flags
             (!habit.keys().hasAny(['isArchived']) || habit.isArchived is bool) &&
             (!habit.keys().hasAny(['contractActive']) || habit.contractActive is bool) &&
             
             // Lists and Maps
             (!habit.keys().hasAny(['specificDays']) || habit.specificDays is list) && 
             (!habit.keys().hasAny(['identityTags']) || habit.identityTags is list) &&
             (!habit.keys().hasAny(['reminderTime']) || habit.reminderTime == null || (habit.reminderTime.keys().hasAll(['hour', 'minute']))) &&
             
             // Numbers and Dates
             (!habit.keys().hasAny(['order']) || habit.order is int) &&
             (!habit.keys().hasAny(['currentStreak']) || habit.currentStreak is int) &&
             (!habit.keys().hasAny(['createdAt']) || habit.createdAt is timestamp);
    }

    // Helper function to validate post content
    function isValidPost(post) {
      return post.keys().hasAll(['content', 'userId', 'createdAt']) &&
             post.keys().size() <= 10 &&
             sanitizeString(post.content) &&
             post.content.size() <= 2000 &&
             post.userId == request.auth.uid &&
             post.createdAt is timestamp;
    }

    // User Stats / Profile (Gamification & Identity)
    match /user_stats/{userId} {
      allow read: if isOwner(userId);

      // CRITICAL: Client-side writes are blocked to prevent cheating
      // Backend (Cloud Functions with Admin SDK) bypasses these rules automatically
      // This ensures XP, Level, and World State are only updated by server-side logic
      allow write: if false;

      // Note: Admin SDK (from Cloud Functions) bypasses Firestore rules entirely
      // See: functions/src/index.ts - onHabitActivity function handles all updates
    }

    // User Profiles (Archetype, Attributes, etc.)
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId) && isValidUser(request.resource.data);
      allow update: if isOwner(userId) && (
        isValidUser(request.resource.data) || 
        // Allow updating specific technical fields without full validation of the entire object
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['fcmToken']))
      );
      allow delete: if isOwner(userId);

      // User Challenges Subcollection
      match /challenges/{challengeId} {
        allow read, write: if isOwner(userId);
      }

      // User Tribes Subcollection
      match /tribes/{tribeId} {
        allow read, write: if isOwner(userId);
      }
    }

    // Habits (Top-level collection) - Enhanced security
    match /habits/{habitId} {
      allow create: if isAuthenticated() && isValidHabit(request.resource.data);
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid && isValidHabit(request.resource.data);
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Habit Contracts
    match /contracts/{contractId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Tribes (Community)
    match /tribes/{tribeId} {
      allow read: if isAuthenticated();
      // Allow authenticated users to create and update tribes (e.g. joining/leaving)
      allow create: if isAuthenticated(); 
      allow update: if isAuthenticated();
      
      // Allow users to join tribes (add themselves to members subcollection)
      match /members/{memberId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(memberId);
      }
    }

    // Challenges
    match /challenges/{challengeId} {
      allow read: if isAuthenticated();
      // Allow authenticated users to create/update for seeding (consider restricting in production)
      allow create, update: if isAuthenticated();
      allow delete: if false; // Admin only

      // Allow users to join challenges
      match /participants/{participantId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(participantId);
      }
    }

    // NOTE: Blueprints collection rules removed - feature integrated into inline templates

    // Social Posts (Feed) - Enhanced security
    match /posts/{postId} {
      allow read: if isAuthenticated() && resource.data.status != 'deleted';
      allow create: if isAuthenticated() && isValidPost(request.resource.data) && rateLimited();
      allow update: if isOwner(resource.data.userId) && isValidPost(request.resource.data) && rateLimited();
      allow delete: if isOwner(resource.data.userId);
    }

    // Insights (Recaps & Reflections)
    match /user_stats/{userId}/recaps/{recapId} {
      allow read: if isOwner(userId);
      allow write: if false; // Generated by backend functions usually
    }

    match /user_stats/{userId}/reflections/{reflectionId} {
      allow read: if isOwner(userId);
      // Allow users to save their own reflections
      allow create: if isOwner(userId) && 
                       request.resource.data.keys().hasAll(['mood', 'createdAt']) &&
                       request.resource.data.mood is string &&
                       request.resource.data.createdAt is timestamp;
      allow update, delete: if isOwner(userId);
    }

    // Affiliate Partners (Read-only for public, Write by Admin)
    match /affiliatePartners/{partnerId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin only via backend
    }

    // Challenge Templates (Read-only, Write by Admin)
    match /challengeTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin only via backend
    }

    // Challenge Requests (Hybrid Accountability)
    match /challenge_requests/{requestId} {
      allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;
      allow read: if isAuthenticated() && 
                 (resource.data.senderId == request.auth.uid || resource.data.recipientId == request.auth.uid);
      allow update: if isAuthenticated() && 
                   (resource.data.recipientId == request.auth.uid || resource.data.senderId == request.auth.uid); // Recipient accepts/declines
    }

    // User Activity (Logs) - For XP and Habit tracking
    match /user_activity/{activityId} {
      // Allow reading logs for the authenticated user
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Allow creating logs if the userId matches the authenticated user
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
  }
}