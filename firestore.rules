rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Input validation - simplified to avoid false positives
    function sanitizeString(input) {
      return input is string &&
             input.size() > 0 &&
             input.size() <= 1000;
    }

    // Helper function to validate email format
    function isValidEmail(email) {
      return email is string &&
             email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    // Helper function to rate limit writes
    function rateLimited() {
      // Simple rate limiting: Allow 10 writes per minute per user
      // In production, this should be backed by Firestore counters or Cloud Functions
      return true;
    }

    // Helper function to validate user data with enhanced security
    function isValidUser(user) {
      return user.keys().size() <= 80 &&
             (!user.keys().hasAny(['email']) || isValidEmail(user.email)) &&
             (!user.keys().hasAny(['displayName']) || (sanitizeString(user.displayName) && user.displayName.size() <= 50)) &&
             (!user.keys().hasAny(['createdAt']) || user.createdAt is timestamp) &&
             // Prevent privilege escalation
             !user.keys().hasAny(['isAdmin', 'role', 'permissions']) &&
             // Ensure nested structures are valid if present
             (!user.keys().hasAny(['avatarStats']) || (
               user.avatarStats is map &&
               user.avatarStats.keys().hasAll(['level', 'streak'])
             )) &&
             (!user.keys().hasAny(['worldState']) || (
               user.worldState is map &&
               user.worldState.keys().hasAll(['entropy', 'cityLevel', 'forestLevel'])
             ));
    }

    // Helper function to validate habit data with enhanced security
    function isValidHabit(habit) {
      return habit.keys().hasAll(['title', 'userId']) &&
             habit.keys().size() <= 50 &&
             sanitizeString(habit.title) &&
             habit.userId == request.auth.uid &&
             
             // Enums and constrained strings
             (!habit.keys().hasAny(['frequency']) || habit.frequency is string) &&
             (!habit.keys().hasAny(['difficulty']) || habit.difficulty is string) &&
             (!habit.keys().hasAny(['impact']) || habit.impact is string) &&
             (!habit.keys().hasAny(['attribute']) || habit.attribute is string) &&
             
             // Boolean flags
             (!habit.keys().hasAny(['isArchived']) || habit.isArchived is bool) &&
             (!habit.keys().hasAny(['contractActive']) || habit.contractActive is bool) &&
             
             // Lists and Maps
             (!habit.keys().hasAny(['specificDays']) || habit.specificDays is list) && 
             (!habit.keys().hasAny(['identityTags']) || habit.identityTags is list) &&
             
             // Numbers and Dates
             (!habit.keys().hasAny(['order']) || habit.order is number) &&
             (!habit.keys().hasAny(['currentStreak']) || habit.currentStreak is number) &&
             (!habit.keys().hasAny(['longestStreak']) || habit.longestStreak is number) &&
             (!habit.keys().hasAny(['createdAt']) || habit.createdAt is timestamp);
    }

    // Helper function to validate post content
    function isValidPost(post) {
      return post.keys().hasAll(['content', 'userId', 'createdAt']) &&
             post.keys().size() <= 10 &&
             sanitizeString(post.content) &&
             post.content.size() <= 2000 &&
             post.userId == request.auth.uid &&
             post.createdAt is timestamp;
    }

    // User Stats / Profile (Gamification & Identity)
    // Synchronized with UserAvatarStats and UserProfile logic
    match /user_stats/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId) && isValidUser(request.resource.data);
      allow update: if isOwner(userId) && isValidUser(request.resource.data);
    }

    // User Profiles (Archetype, Attributes, etc.)
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId) && isValidUser(request.resource.data);
      allow update: if isOwner(userId) && (
        isValidUser(request.resource.data) || 
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['fcmToken']))
      );
      allow delete: if isOwner(userId);

      // User Challenges Subcollection
      match /challenges/{challengeId} {
        allow read, write: if isOwner(userId);
      }

      // User Tribes Subcollection
      match /tribes/{tribeId} {
        allow read, write: if isOwner(userId);
      }

      // User Friends Subcollection
      match /friends/{friendId} {
        allow read, write: if isOwner(userId);
      }
    }

    // Habits (Top-level collection) - Enhanced security
    match /habits/{habitId} {
      allow create: if isAuthenticated() && isValidHabit(request.resource.data);
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid && isValidHabit(request.resource.data);
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Habit Contracts
    match /contracts/{contractId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Tribes (Community)
    match /tribes/{tribeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid; 
      allow update: if isAuthenticated();
      
      match /members/{memberId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(memberId);
      }
    }

    // Challenges
    match /challenges/{challengeId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false;

      match /participants/{participantId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(participantId);
      }
    }

    // Social Posts (Feed)
    match /posts/{postId} {
      allow read: if isAuthenticated() && resource.data.status != 'deleted';
      allow create: if isAuthenticated() && isValidPost(request.resource.data) && rateLimited();
      allow update: if isOwner(resource.data.userId) && isValidPost(request.resource.data) && rateLimited();
      allow delete: if isOwner(resource.data.userId);
    }

    // Insights (Recaps & Reflections)
    match /user_stats/{userId}/recaps/{recapId} {
      allow read: if isOwner(userId);
      allow write: if false;
    }

    match /user_stats/{userId}/reflections/{reflectionId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId) && 
                       request.resource.data.keys().hasAll(['mood', 'createdAt']) &&
                       request.resource.data.mood is string &&
                       request.resource.data.createdAt is timestamp;
      allow update, delete: if isOwner(userId);
    }

    // Affiliate Partners (Read-only for public, Write by Admin)
    match /affiliatePartners/{partnerId} {
      allow read: if isAuthenticated();
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // Challenge Templates (Read-only, Write by Admin)
    match /challengeTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // Challenge Requests (Hybrid Accountability)
    match /challenge_requests/{requestId} {
      allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;
      allow read: if isAuthenticated() && 
                 (resource.data.senderId == request.auth.uid || resource.data.recipientId == request.auth.uid);
      allow update: if isAuthenticated() && 
                   (resource.data.recipientId == request.auth.uid || resource.data.senderId == request.auth.uid);
    }

    // User Activity (Logs) - For XP and Habit tracking
    match /user_activity/{activityId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
  }
}